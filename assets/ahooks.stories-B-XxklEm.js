import{j as y}from"./jsx-runtime-g8yQ8zum.js";import{H,I as g,J as b,K as R,N as B,O as Q,Q as O,R as X,S as Y,U as Z,V as $,W as I,X as P}from"./localforage-CMQ_39Cb.js";import{r as h}from"./iframe-C-8Nr3SK.js";import"./environment-DBAZUceu.js";import"./_commonjs-dynamic-modules-gkIWivl6.js";import"./isNumber-4fTjEZSw.js";import"./index-CP6h2BGR.js";import"./index-C0Aql9EX.js";import"./preload-helper-D9Z9MdNV.js";var ee=function(n){return typeof n=="function"},k=function(n,e){var r=e.manual,t=e.ready,i=t===void 0?!0:t,u=e.defaultParams,o=u===void 0?[]:u,d=e.refreshDeps,s=d===void 0?[]:d,c=e.refreshDepsAction,v=h.useRef(!1);return v.current=!1,H(function(){!r&&i&&(v.current=!0,n.run.apply(n,g([],b(o),!1)))},[i]),H(function(){v.current||r||(v.current=!0,c?c():n.refresh())},g([],b(s),!1)),{onBefore:function(){if(!i)return{stopNow:!0}}}};k.onInit=function(n){var e=n.ready,r=e===void 0?!0:e,t=n.manual;return{loading:!t&&r}};function ne(n,e){if(n===e)return!0;for(var r=0;r<n.length;r++)if(!Object.is(n[r],e[r]))return!1;return!0}var V=function(n,e){var r=h.useRef({deps:e,obj:void 0,initialized:!1}).current;return(r.initialized===!1||!ne(r.deps,e))&&(r.deps=e,r.obj=n(),r.initialized=!0),r.obj},E=new Map,re=function(n,e,r){var t=E.get(n);t?.timer&&clearTimeout(t.timer);var i=void 0;e>-1&&(i=setTimeout(function(){E.delete(n)},e)),E.set(n,R(R({},r),{timer:i}))},te=function(n){return E.get(n)},x=new Map,ie=function(n){return x.get(n)},ue=function(n,e){x.set(n,e),e.then(function(r){return x.delete(n),r}).catch(function(){x.delete(n)})},w={},ae=function(n,e){w[n]&&w[n].forEach(function(r){return r(e)})},D=function(n,e){return w[n]||(w[n]=[]),w[n].push(e),function(){var t=w[n].indexOf(e);w[n].splice(t,1)}},oe=function(n,e){var r=e.cacheKey,t=e.cacheTime,i=t===void 0?300*1e3:t,u=e.staleTime,o=u===void 0?0:u,d=e.setCache,s=e.getCache,c=h.useRef(void 0),v=h.useRef(void 0),a=function(l,f){d?d(f):re(l,i,f),ae(l,f.data)},m=function(l,f){return f===void 0&&(f=[]),s?s(f):te(l)};return V(function(){if(r){var l=m(r);l&&Object.hasOwnProperty.call(l,"data")&&(n.state.data=l.data,n.state.params=l.params,(o===-1||Date.now()-l.time<=o)&&(n.state.loading=!1)),c.current=D(r,function(f){n.setState({data:f})})}},[]),B(function(){var l;(l=c.current)===null||l===void 0||l.call(c)}),r?{onBefore:function(l){var f=m(r,l);return!f||!Object.hasOwnProperty.call(f,"data")?{}:o===-1||Date.now()-f.time<=o?{loading:!1,data:f?.data,error:void 0,returnNow:!0}:{data:f?.data,error:void 0}},onRequest:function(l,f){var p=ie(r);return p&&p!==v.current?{servicePromise:p}:(p=l.apply(void 0,g([],b(f),!1)),v.current=p,ue(r,p),{servicePromise:p})},onSuccess:function(l,f){var p;r&&((p=c.current)===null||p===void 0||p.call(c),a(r,{data:l,params:f,time:Date.now()}),c.current=D(r,function(T){n.setState({data:T})}))},onMutate:function(l){var f;r&&((f=c.current)===null||f===void 0||f.call(c),a(r,{data:l,params:n.state.params,time:Date.now()}),c.current=D(r,function(p){n.setState({data:p})}))}}:{}},se=function(n,e){var r=e.debounceWait,t=e.debounceLeading,i=e.debounceTrailing,u=e.debounceMaxWait,o=h.useRef(void 0),d=h.useMemo(function(){var s={};return t!==void 0&&(s.leading=t),i!==void 0&&(s.trailing=i),u!==void 0&&(s.maxWait=u),s},[t,i,u]);return h.useEffect(function(){if(r){var s=n.runAsync.bind(n);return o.current=Q(function(c){c()},r,d),n.runAsync=function(){for(var c=[],v=0;v<arguments.length;v++)c[v]=arguments[v];return new Promise(function(a,m){var l;(l=o.current)===null||l===void 0||l.call(o,function(){s.apply(void 0,g([],b(c),!1)).then(a).catch(m)})})},function(){var c;(c=o.current)===null||c===void 0||c.cancel(),n.runAsync=s}}},[r,d]),r?{onCancel:function(){var s;(s=o.current)===null||s===void 0||s.cancel()}}:{}},ce=function(n,e){var r=e.loadingDelay,t=e.ready,i=h.useRef(void 0);if(!r)return{};var u=function(){i.current&&clearTimeout(i.current)};return{onBefore:function(){return u(),t!==!1&&(i.current=setTimeout(function(){n.setState({loading:!0})},r)),{loading:!1}},onFinally:function(){u()},onCancel:function(){u()}}};function M(){return O?document.visibilityState!=="hidden":!0}var _=new Set;function le(n){return _.add(n),function(){_.has(n)&&_.delete(n)}}if(O){var fe=function(){M()&&_.forEach(function(n){return n()})};window.addEventListener("visibilitychange",fe,!1)}var de=function(n,e){var r=e.pollingInterval,t=e.pollingWhenHidden,i=t===void 0?!0:t,u=e.pollingErrorRetryCount,o=u===void 0?-1:u,d=h.useRef(void 0),s=h.useRef(void 0),c=h.useRef(0),v=function(){var a;d.current&&clearTimeout(d.current),(a=s.current)===null||a===void 0||a.call(s)};return H(function(){r||v()},[r]),r?{onBefore:function(){v()},onError:function(){c.current+=1},onSuccess:function(){c.current=0},onFinally:function(){o===-1||o!==-1&&c.current<=o?d.current=setTimeout(function(){!i&&!M()?s.current=le(function(){n.refresh()}):n.refresh()},r):c.current=0},onCancel:function(){v()}}:{}};function ve(n,e){var r=!1;return function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];r||(r=!0,n.apply(void 0,g([],b(t),!1)),setTimeout(function(){r=!1},e))}}var me=function(){return O&&typeof navigator.onLine<"u"?navigator.onLine:!0},A=new Set;function he(n){return A.add(n),function(){A.has(n)&&A.delete(n)}}if(O){var z=function(){!M()||!me()||A.forEach(function(n){return n()})};window.addEventListener("visibilitychange",z,!1),window.addEventListener("focus",z,!1)}var pe=function(n,e){var r=e.refreshOnWindowFocus,t=e.focusTimespan,i=t===void 0?5e3:t,u=h.useRef(void 0),o=function(){var d;(d=u.current)===null||d===void 0||d.call(u)};return h.useEffect(function(){if(r){var d=ve(n.refresh.bind(n),i);u.current=he(function(){d()})}return function(){o()}},[r,i]),B(function(){o()}),{}},ge=function(n,e){var r=e.retryInterval,t=e.retryCount,i=h.useRef(void 0),u=h.useRef(0),o=h.useRef(!1);return t?{onBefore:function(){o.current||(u.current=0),o.current=!1,i.current&&clearTimeout(i.current)},onSuccess:function(){u.current=0},onError:function(){if(u.current+=1,t===-1||u.current<=t){var d=r??Math.min(1e3*Math.pow(2,u.current),3e4);i.current=setTimeout(function(){o.current=!0,n.refresh()},d)}else u.current=0},onCancel:function(){u.current=0,i.current&&clearTimeout(i.current)}}:{}},be=function(n,e){var r=e.throttleWait,t=e.throttleLeading,i=e.throttleTrailing,u=h.useRef(void 0),o={};return t!==void 0&&(o.leading=t),i!==void 0&&(o.trailing=i),h.useEffect(function(){if(r){var d=n.runAsync.bind(n);return u.current=X(function(s){s()},r,o),n.runAsync=function(){for(var s=[],c=0;c<arguments.length;c++)s[c]=arguments[c];return new Promise(function(v,a){var m;(m=u.current)===null||m===void 0||m.call(u,function(){d.apply(void 0,g([],b(s),!1)).then(v).catch(a)})})},function(){var s;n.runAsync=d,(s=u.current)===null||s===void 0||s.cancel()}}},[r,t,i]),r?{onCancel:function(){var d;(d=u.current)===null||d===void 0||d.cancel()}}:{}},ye=function(n){h.useEffect(function(){var e=n?.();if(!(e&&typeof e=="object"&&typeof e.then=="function"))return e},[])},Re=function(){var n=b(h.useState({}),2),e=n[1];return h.useCallback(function(){return e({})},[])},we=(function(){function n(e,r,t,i){i===void 0&&(i={}),this.serviceRef=e,this.options=r,this.subscribe=t,this.initState=i,this.count=0,this.state={loading:!1,params:void 0,data:void 0,error:void 0},this.state=R(R(R({},this.state),{loading:!r.manual}),i)}return n.prototype.setState=function(e){e===void 0&&(e={}),this.state=R(R({},this.state),e),this.subscribe()},n.prototype.runPluginHandler=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];var i=this.pluginImpls.map(function(u){var o;return(o=u[e])===null||o===void 0?void 0:o.call.apply(o,g([u],b(r),!1))}).filter(Boolean);return Object.assign.apply(Object,g([{}],b(i),!1))},n.prototype.runAsync=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return Y(this,void 0,void 0,function(){var t,i,u,o,d,s,c,v,a,m,l,f,p,T,q,N,F,G,L,U,W;return Z(this,function(j){switch(j.label){case 0:if(this.count+=1,t=this.count,i=this.runPluginHandler("onBefore",e),u=i.stopNow,o=u===void 0?!1:u,d=i.returnNow,s=d===void 0?!1:d,c=$(i,["stopNow","returnNow"]),o)return[2,new Promise(function(){})];if(this.setState(R({loading:!0,params:e},c)),s)return[2,Promise.resolve(c.data)];(p=(f=this.options).onBefore)===null||p===void 0||p.call(f,e),j.label=1;case 1:return j.trys.push([1,3,,4]),v=this.runPluginHandler("onRequest",this.serviceRef.current,e).servicePromise,v||(v=(l=this.serviceRef).current.apply(l,g([],b(e),!1))),[4,v];case 2:return a=j.sent(),t!==this.count?[2,new Promise(function(){})]:(this.setState({data:a,error:void 0,loading:!1}),(q=(T=this.options).onSuccess)===null||q===void 0||q.call(T,a,e),this.runPluginHandler("onSuccess",a,e),(F=(N=this.options).onFinally)===null||F===void 0||F.call(N,e,a,void 0),t===this.count&&this.runPluginHandler("onFinally",e,a,void 0),[2,a]);case 3:if(m=j.sent(),t!==this.count)return[2,new Promise(function(){})];throw this.setState({error:m,loading:!1}),(L=(G=this.options).onError)===null||L===void 0||L.call(G,m,e),this.runPluginHandler("onError",m,e),(W=(U=this.options).onFinally)===null||W===void 0||W.call(U,e,void 0,m),t===this.count&&this.runPluginHandler("onFinally",e,void 0,m),m;case 4:return[2]}})})},n.prototype.run=function(){for(var e=this,r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];this.runAsync.apply(this,g([],b(r),!1)).catch(function(i){e.options.onError||console.error(i)})},n.prototype.cancel=function(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")},n.prototype.refresh=function(){this.run.apply(this,g([],b(this.state.params||[]),!1))},n.prototype.refreshAsync=function(){return this.runAsync.apply(this,g([],b(this.state.params||[]),!1))},n.prototype.mutate=function(e){var r=ee(e)?e(this.state.data):e;this.runPluginHandler("onMutate",r),this.setState({data:r})},n})();function Pe(n,e,r){e===void 0&&(e={}),r===void 0&&(r=[]);var t=e.manual,i=t===void 0?!1:t,u=e.ready,o=u===void 0?!0:u,d=$(e,["manual","ready"]),s=R({manual:i,ready:o},d),c=I(n),v=Re(),a=V(function(){var m=r.map(function(l){var f;return(f=l?.onInit)===null||f===void 0?void 0:f.call(l,s)}).filter(Boolean);return new we(c,s,v,Object.assign.apply(Object,g([{}],b(m),!1)))},[]);return a.options=s,a.pluginImpls=r.map(function(m){return m(a,s)}),ye(function(){if(!i&&o){var m=a.state.params||e.defaultParams||[];a.run.apply(a,g([],b(m),!1))}}),B(function(){a.cancel()}),{loading:a.state.loading,data:a.state.data,error:a.state.error,params:a.state.params||[],cancel:P(a.cancel.bind(a)),refresh:P(a.refresh.bind(a)),refreshAsync:P(a.refreshAsync.bind(a)),run:P(a.run.bind(a)),runAsync:P(a.runAsync.bind(a)),mutate:P(a.mutate.bind(a))}}function J(n,e,r){return Pe(n,e,g(g([],b([]),!1),[se,ce,de,pe,be,k,oe,ge],!1))}function je(n,e,r){return J(n,{onError:t=>{setTimeout(()=>{throw t},0)},...e,__ignore:!0})}const Fe={title:"@fe-free/core/ahooks",tags:["autodocs"],parameters:{docs:{description:{component:`基于 ahooks 封装
- useGlobalRequest。基于 useRequest 封装，会抛出全局错误。
- useGlobalInfiniteScroll。基于 useInfiniteScroll 封装，会抛出全局错误。
`}}}},K=n=>{console.log("global error",n),alert("global error")};window.addEventListener("error",K);window.addEventListener("unhandledrejection",K);const C=()=>{const{data:n,loading:e,error:r,run:t}=je(async()=>new Promise((i,u)=>{setTimeout(()=>{u("错误啦")},1e3)}),{manual:!0});return y.jsxs("div",{children:[y.jsx("div",{children:"useGlobalRequest 会抛出全局错误"}),y.jsx("button",{onClick:t,children:"run"}),y.jsxs("div",{children:["data: ",n]}),y.jsxs("div",{children:["loading: ",e?"true":"false"]}),y.jsxs("div",{children:["error: ",r]})]})},S=()=>{const{data:n,loading:e,error:r,run:t}=J(async()=>new Promise((i,u)=>{setTimeout(()=>{u("错误啦")},1e3)}),{manual:!0});return y.jsxs("div",{children:[y.jsx("div",{children:"ahooks useRequest"}),y.jsx("button",{onClick:t,children:"run"}),y.jsxs("div",{children:["data: ",n]}),y.jsxs("div",{children:["loading: ",e?"true":"false"]}),y.jsxs("div",{children:["error: ",r]})]})};C.__docgenInfo={description:"",methods:[],displayName:"UseGlobalRequest"};S.__docgenInfo={description:"",methods:[],displayName:"UseRequest"};C.parameters={...C.parameters,docs:{...C.parameters?.docs,source:{originalSource:`() => {
  const {
    data,
    loading,
    error,
    run
  } = useGlobalRequest(async () => {
    return new Promise((_, reject) => {
      setTimeout(() => {
        reject('错误啦');
      }, 1000);
    });
  }, {
    manual: true
  });
  return <div>
      <div>useGlobalRequest 会抛出全局错误</div>
      <button onClick={run}>run</button>

      <div>data: {data}</div>
      <div>loading: {loading ? 'true' : 'false'}</div>
      <div>error: {error}</div>
    </div>;
}`,...C.parameters?.docs?.source}}};S.parameters={...S.parameters,docs:{...S.parameters?.docs,source:{originalSource:`() => {
  const {
    data,
    loading,
    error,
    run
  } = useRequest(async () => {
    return new Promise((_, reject) => {
      setTimeout(() => {
        reject('错误啦');
      }, 1000);
    });
  }, {
    manual: true
  });
  return <div>
      <div>ahooks useRequest</div>
      <button onClick={run}>run</button>
      <div>data: {data}</div>
      <div>loading: {loading ? 'true' : 'false'}</div>
      <div>error: {error}</div>
    </div>;
}`,...S.parameters?.docs?.source}}};const Le=["UseGlobalRequest","UseRequest"];export{C as UseGlobalRequest,S as UseRequest,Le as __namedExportsOrder,Fe as default};
