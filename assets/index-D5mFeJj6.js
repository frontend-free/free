function w(){let r=null,i=null,o=null,s=null,d=[];async function l({onAudio:a,onError:t}){try{s=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new AudioContext({sampleRate:16e3}),i=o.createMediaStreamSource(s),r=o.createScriptProcessor(4096,1,1),d=[],r.onaudioprocess=function(e){const c=e.inputBuffer.getChannelData(0),f=new Int16Array(c.length);for(let u=0;u<c.length;u++){const p=Math.max(-1,Math.min(1,c[u]));f[u]=p<0?p*32768:p*32767}d.push(f.buffer),a(f.buffer)},i.connect(r),r.connect(o.destination)}catch(e){throw e instanceof DOMException&&e.name==="NotAllowedError"?t?.(new Error("请允许麦克风权限")):e instanceof DOMException&&e.name==="NotFoundError"?t?.(new Error("未找到麦克风设备")):e instanceof DOMException&&e.name==="NotReadableError"?t?.(new Error("麦克风被其他应用占用")):t?.(new Error("启动录音失败")),e}}async function n(){r&&r.disconnect(),i&&i.disconnect(),o&&o.close(),s&&s.getTracks().forEach(t=>t.stop());const a=d;return d=[],{data:a}}return{start:l,stop:n}}function m(){let r=null,i=null,o=[];async function s({onAudio:l,onError:n,mimeType:a="audio/webm"}){try{i=await navigator.mediaDevices.getUserMedia({audio:!0});let t=a;MediaRecorder.isTypeSupported(a)||(t="",console.warn(`不支持的 MIME 类型: ${a}，使用默认类型`)),r=new MediaRecorder(i,{mimeType:t||void 0}),o=[],r.ondataavailable=e=>{e.data&&e.data.size>0&&(o.push(e.data),l?.(e.data))},r.onerror=()=>{const e=new Error("MediaRecorder 录音错误");n?.(e)},r.start(100)}catch(t){throw t instanceof DOMException&&t.name==="NotAllowedError"?n?.(new Error("请允许麦克风权限")):t instanceof DOMException&&t.name==="NotFoundError"?n?.(new Error("未找到麦克风设备")):t instanceof DOMException&&t.name==="NotReadableError"?n?.(new Error("麦克风被其他应用占用")):n?.(new Error("启动录音失败")),t}}async function d(){return new Promise((l,n)=>{if(!r){n(new Error("MediaRecorder 未初始化"));return}function a(){const t=new Blob(o,{type:r?.mimeType||"audio/webm"});o=[],i&&i.getTracks().forEach(c=>c.stop());const e=new FileReader;e.onloadend=()=>{const c=e.result;l({data:t,base64:c})},e.onerror=()=>{n(new Error("转换为 base64 失败"))},e.readAsDataURL(t)}r.onstop=()=>{a()},r.state==="recording"?r.stop():a()})}return{start:s,stop:d}}export{m as a,w as g};
